---
title: "Scan-Centric, Frequency-Based Method for Characterizing Peaks from Direct Injection Fourier transform Mass Spectrometry Experiments"
author:
  - Robert M Flight:
      email: robert.flight@uky.edu
      institute: [markey, biochem, rcsirm]
  - Joshua M Mitchell:
      email: jmmi243@uky.edu
      institute: [markey, biochem, rcsirm]
  - Hunter NB Moseley:
      email: hunter.moseley@uky.edu
      correspondence: true
      institute: [markey, biochem, rcsirm, ibi, tox]
institute:
  - markey: Markey Cancer Center, University of Kentucky, Lexington, KY 40536, USA
  - biochem: Department of Molecular & Cellular Biochemistry, University of Kentucky, Lexington, KY 40536, USA
  - rcsirm: Resource Center for Stable Isotope Resolved Metabolomics, University of Kentucky, Lexington, KY 40536, USA
  - ibi: Institute for Biomedical Informatics, University of Kentucky, Lexington, KY 40536, USA
  - tox: Department of Toxicology and Cancer Biology, University of Kentucky, Lexington, KY 40536, USA
output: 
  word_document:
    reference_docx: metabolites-template-v3.docx
    keep_md: true
    pandoc_args:
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: '`r here::here("doc/peakcharacterization.json")`'
csl: plos-computational-biology.csl
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: sentence
---

```{r get_setup, include = FALSE}
source(here::here("packages.R"))
lapply(list.files(here::here("./R"), full.names = TRUE), source)


figure_count = dn_counter$new("Figure ")
table_count = dn_counter$new("Table ")
equation_count = dn_counter$new("")

supp_figure_count = readRDS("doc/supplemental_figure_count.rds")
supp_table_count = readRDS("doc/supplemental_table_count.rds")
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width = 8, 
                      fig.height = 6, 
                      fig.process = dn_modify_path,
                      dpi = 600,
                      dev.args = list(png = list(type = "cairo")))

format_equation = function(equation_text, label){
  number_out = equation_count$label_text(label)
  paste0('$$\n\\begin{align}\n', equation_text, '&& \\text{(', number_out, ')}', '\n\\end{align}$$')
}
```

```{r increment_equations}
equation_count$increment("mzfrequency")
equation_count$increment("frequencymz")
equation_count$increment("modelintensity")
equation_count$increment("napintensity")
```


::: {custom-style="MDPI_1.7_abstract"}
**Abstract:** We present a novel, scan-centric method for characterizing peaks from direct injection multi-scan Fourier transform mass spectra of complex samples that utilizes frequency values derived directly from the spacing of raw m/z points in spectral scans.
Our peak characterization method utilizes intensity independent noise removal and normalization of scan-level data to provide a much better fit of relative intensity to natural abundance probabilities for low abundance isotopologues that are not present in all of the acquired scans.
Moreover, our method calculates both peak- and scan-specific statistics incorporated within a series of quality control steps that are designed to robustly derive peak centers, intensities and intensity ratios with their scan-level variances.
These cross-scan characterized peaks are suitable for use in our previously published peak assignment methodology, Small Molecule Isotope Resolved Formula Enumeration (SMIRFE).
:::

::: {custom-style="MDPI_1.8_keywords"}
**Keywords**: Fourier-transform mass spectrometry
:::

::: {custom-style="MDPI_2.1_heading1"}
## 1. Introduction
:::


::: {custom-style="MDPI_3.1_text"}
Fourier-transform mass spectrometry (FT-MS) provides high performance in terms of sensitivity, resolution, and mass accuracy all in one analytical instrumentation.
The combination of these capabilities provide several analytical and interpretive improvements: (i) the ability to resolve distinct isotopologues with identical unit masses but different accurate masses [@higashiStableIsotopeLabeledTracers2014]; (ii)  enabling multi-element isotopic natural abundance correction for at least the lower portion of the detected mass range  [@moseleyCorrectingEffectsNatural2010; @carreerComputationalFrameworkHighThroughput2013; @wangAccuCor2IsotopeNatural2021]; (iii) improved assignment accuracy [@kindMetabolomicDatabaseAnnotations2006; @mitchellSmallMoleculeIsotope2019]; and (iv) the detection of metabolites in the sub-femtomolar range, when combined with chromatographic separation  [@eylesMethodsStudyProtein2004; @dettmerMassSpectrometrybasedMetabolomics2007]. 
In the metabolomics field, these improvements permit more complicated, but more informative experimental designs such as the use of single and multiple isotope-labeled precursors in stable isotope-resolved metabolomics (SIRM) experiments [@yangChloroformateDerivatizationTracing2017].
These stable isotope tracing experiments provide a wealth of isotope flux data that is interpretable in terms of metabolite flux information that is specific to a metabolic model, pathway, and subcellular location [@higashiStableIsotopeLabeledTracers2014; @creekStableIsotopeAssistedMetabolomics2012; @hillerNontargetedElucidationMetabolic2010; @fanStableIsotoperesolvedMetabolomics2012; @moseleyNovelDeconvolutionMethod2011; @sellersPyruvateCarboxylaseCritical2015; @verdegemMAIMSSoftwareTool2017; @jinMoietyModelingFramework2019; @jinRobustMoietyModel2020].

While these advantages of FT-MS are significant, when deployed in a high-throughput environment, the volume of data produced requires automated tools for data reduction, quality control, feature assignment, and downstream analyses. 
Furthermore within the context of direct infusion, assignment of FT-MS spectral features lacks orthogonal sources of information such as chromatographic retention times, reducing the reliability of assignment with most MS assignment software tools.

Within this combined high-throughput with direct injection context, we previously developed methods to remove high-peak-density artifacts [@mitchellNewMethodsIdentify2018], annotate peaks with assignments using SMIRFE [@mitchellSmallMoleculeIsotope2019], and generate lipid classifications for spectral peak assignments [@mitchellDerivingLipidClassification2020].
We applied all of these methods together in detecting and assigning differential lipids in non-small-cell lung carcinoma (NSCLC) [@mitchellUntargetedLipidomicsNonSmall2021].

The input peak data in these studies are derived from multi-scan direct-injection FT-MS data.
SMIRFE uses expected relationships of relative peak height or intensity to natural abundance probability (NAP) across multiple peak pairs to determine the likelihood of an assignment for the peaks in question.
In the Thermo-Fisher Orbitrap FT-MS instruments, data is acquired in microscans and scans, where each scan is an aggregate of multiple microscans.
While these micro-scan and subsequent scans are expected to be analytical replicates, spray instability and temporal delay in automatic gain control pragmatically break this expectation.
Therefore, it is advantageous to keep the data at the scan level, so that any given poor quality (i.e., "bad") scan can be removed prior to aggregating the data across scans and generating a centroided peak m/z and intensity.
If the scan level data is not processed and aggregated correctly, the final peak intensities in arbitrary units and centers in m/z will have high uncertainty (total variance) [@moseleyErrorAnalysisPropagation2013].

In particular, if peaks are missing in some scans due to low abundance, the final aggregate peak intensities will not fit the expected relative intensity to NAP relationships.
Here we describe novel scan-centric FT-MS metabolomics data processing methods that better preserve the expected relative intensity to NAP.
In addition, due to the tendency of increasing point spacing with increasing m/z in Orbitrap type instruments, we derive a method for transforming the m/z data to axial frequency, which has the desirable property of being equally spaced across the full spectrum.
Finally, we show that in addition to better preserving the expected intensity to NAP relationships, our scan-centric method also results in improved relative standard deviations, automatic identification of high-peak-density artifact peaks, and better separation of samples in a lipidomics data analysis.
:::

::: {custom-style="MDPI_2.1_heading1"}
## 2. Results
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.1 Simplistically Averaged Data Have Bad Relative Intensities
:::

```{r increment_motivation}
figure_count$increment("motivation")
```

::: {custom-style="MDPI_3.1_text"}
To motivate our solution, we generated peak lists using the peak exporting functionality in Xcalibur as well as our scan-centric peak characterization, and found matching Xcalibur peaks to our assignments.
As an example, in `r figure_count$label_text("motivation")`, we show the Xcalibur calculated intensities from the simplistically averaged spectrum and theoretical peak intensities based on NAP for four peaks assigned to threonine.
As the peak intensity decreases, the deviation between the Xcalibur calculated intensity and its corresponding NAP-based theoretical intensity become larger.
This becomes more apparent when plotting the two sets of intensities directly against each other, as shown in `r figure_count$label_text("motivation")`B.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r motivation, dn_id = figure_count, fig.width = 10, fig.height = 6}
tar_load(motivation_plot)
motivation_plot
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("motivation")`.**
**A** Xcalibur intensities (black) and theoretical intensities based on relative NAP (red) for ECF derived threonine.
The 18O isotopologue is shifted by 0.01 m/z and the NAP peaks by 0.05 m/z to aid visualization.
**B** Theoretical NAP-based-Log10-intensities and Log10 Xcalibur intensities.
The red line indicates perfect agreement.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.2 m/z to Frequency
:::

```{r increment_mz_frequency}
figure_count$increment("mz_frequency_conversion")
```

::: {custom-style="MDPI_3.1_text"}
FT-MS data from the Thermo-Fisher Orbitrap instruments used to acquire the data does not provide any information about the raw spectral frequency data.
Outside of the meta-data, it merely contains the m/z and intensity values for profile spectra acquired across multiple scans.
However, the spectral frequency can be calculated by dividing the midpoint m/z of two adjacent points by their difference (`r figure_count$label_text("mz_frequency_conversion")`A, red points representing the midpoint m/z of two adjacent points, length of red lines representing the difference between the two adjacent points).
The subsequent adjacent point differences in frequency are expected to be relatively constant with respect to m/z, as shown in `r figure_count$label_text("mz_frequency_conversion")`C, D and E, in contrast to the adjacent point differences in m/z, which are not constant with respect to m/z.
The Thermo-Fisher Fusion instrument from which most of our collaborators data has been acquired, at a resolution of 450K or 500K depending on the sample, has an adjacent frequency point difference mode of 0.5, as shown in  `r figure_count$label_text("mz_frequency_conversion")`D.
It is important to note that although the frequency difference has been consistent regardless of instrument resolution, we do not know a priori what it should be, and the method makes no assumptions about the frequency difference, but rather calculates the mode of the frequency differences from those observed in the data itself.
Restricting to those points that fall into a narrow range around the mode of frequency differences (0.49 - 0.51 in this work), a regression model of frequency to m/z can be generated (see Methods), with an example shown in `r figure_count$label_text("mz_frequency_conversion")`F.
This regression model seems to fit the known relationship between frequency and m/z, where the frequency is related to $1/\sqrt{mz}$.
The actual regression model used in this work includes terms of the m/z, $\sqrt{m/z}$, and $\sqrt[3]{m/z}$ (see **Conversion of m/z to Frequency** in Methods for further description of the regression model).
We did investigate a variety of frequency regression models to see which one seemed to be the best, as shown in Supplemental `r supp_figure_count$label_text("frequency_models")` and `r supp_table_count$label_text("frequency_models")`.

The constant point difference of frequency space is useful, because some of the subsequent steps in our workflow use sliding and tiled windows where it is assumed that the sliding windows contain the same number of data points.
The m/z point-to-point differences are not constant, but can be approximated by a LOESS linear model [@Cleveland1992loess]; however, it is exceedingly difficult to create a LOESS model with an intercept of 0.
In addition, we would also need to vary the width of sliding windows according to the m/z difference at a particular m/z based on the LOESS model.
Frequency-based points suffer none of these drawbacks, and the conversion from m/z can be derived from the raw profile level data itself, which is incredibly useful.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r mz_frequency_conversion, dn_id = figure_count, fig.width = 16, fig.height = 10}
tar_load(frequency_conversion)
frequency_conversion$all
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("mz_frequency_conversion")`.** 
**A**: Intensity vs m/z for a single peak from a single scan.
Red lines denote the difference between each adjacent pair of points, and red dots the m/z midpoint between the pair of points.
The difference divided by the midpoint is used to derive the spectral frequency values in **B**.
**B** plots the intensity vs the converted frequency points derived from **A**.
The red lines denote the difference between adjacent points, which are shown in the y-axis of **C** for this single peak.
A histogram of adjacent point differences for all points is shown in **D**.
The differences for all points in a single scan vs m/z are shown in **E**, with those differences that lie within 0.49 - 0.51 shown in red.
**F** shows the plot of derived spectral frequency vs m/z, with fitted values from the linear regression model in red.
:::

```{r increment_peak_ordering}
figure_count$increment("peak_ordering")
```

::: {custom-style="MDPI_3.1_text"}
The m/z to frequency regression models are calculated for each scan, and the square root term from all scan level models are checked for outliers based on the interquartile ranges across all scans in a sample.
While scan specific models **could** be used in the conversion of m/z to frequency, doing so results in changes to the relative peak ordering compared to m/z space, as shown in `r figure_count$label_text("peak_ordering")`.
Therefore, a single model for all scans based on the scan with the slope closest to the median of slopes across scans is used for converting *all* remaining scan level data.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r peak_ordering, dn_id = figure_count}
tar_load(peak_ordering)
peak_ordering
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("peak_ordering")`.** Peak ordering in m/z compared with ordering in frequency space when a single m/z to frequency model is used or scan specific m/z to frequency models are used.
For a single peak, the scan level peak m/z's were extracted, and then frequency values for those m/z generated using a single common model of m/z to frequency (*Single Model*), or models derived from each scan (*Individual Models*).
A subset of the peaks ends up out of order using scan specific models, implying that a single model should be used across all the scan level data.
:::

::: {custom-style="MDPI_3.1_text"}
Although the original model is created from only those points that had frequency point-to-point differences within a narrow range, **all** m/z points are converted to frequency for subsequent steps in the workflow.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.3 Sliding Window Density to Remove Noise
:::

```{r increment_slidingwindow}
figure_count$increment("slidingwindow_count")
figure_count$increment("percentile_variation")
tar_load(mn_ratios)
tar_load(sliding_regions)
tar_load(example_sliding_region)
tar_load(noise_plot)
```

::: {custom-style="MDPI_3.1_text"}
In a dataset of this nature, we expect that much of the data is really just noise, and does not contribute meaningfully to the analysis.
Furthermore, it is expected that noise is randomly distributed across the scans.
Therefore, if we slide a window across the data and sum the number of non-zero points in each window, we expect that most of the data we encounter is actually noise.
Subsequently, we divide the counts into tiled regions of a set size (1000 frequency in this work), and examine the 99th percentile of the sliding window counts within the tiled region.
In `r figure_count$label_text("slidingwindow_count")`A we plotted the non-zero point intensities from all scans for one tiled region 2000 points wide.
The number of non-zero points in the sliding windows across this region are shown in `r figure_count$label_text("slidingwindow_count")`B, and zoomed in in C.
These provide a measure of the non-zero point density across this region.
The blue line indicates the cumulative 99th percentile for this one region, and is high, given that it looks like there are some consistent peaks across the scans in this region.
However, examining the cumulative 99th percentiles across all the regions of the spectrum, as shown in the histogram of `r figure_count$label_text("slidingwindow_count")`F, a rather large fraction of the regions have very low cumulative 99th percentile values, with a median value of 5, which results in a cutoff value of 8 (ceiling of 5 x 1.5).
Keeping only those sliding regions with a non-zero point count greater than 8 (above the red line in `r figure_count$label_text("slidingwindow_count")`B and C) results in those sliding regions shown in D, and then the point intensities in E.
A non-zero point density based method to removing potential noise is desirable because the peak intensities across scans are not identical, as shown by the need for normalization (see **Normalization of Scans**), and the distribution of RSD values before and after normalization (see **Changes in Relative Standard Deviation**).
:::


::: {custom-style="MDPI_5.2_figure"}

```{r slidingwindow_count, dn_id = figure_count, fig.width = 12, fig.height = 8}
(example_sliding_region | sliding_regions) + plot_annotation(tag_levels = "A")
```

:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("slidingwindow_count")`.**
**A - E**: A single tiled region 2000 data points wide.
**A**: Non-zero point intensities in frequency space across all scans.
**B**: Number of non-zero points in sliding regions. Blue line indicates 99th percentile of non-zero counts in this one region.
Red line is the rounded value of median x 1.5 of 99th percentiles from **F**.
**C**: Zoomed y-axis of **B** to show the non-zero counts that are below the median cutoff.
**D**: Sliding region non-zero counts that are greater than the cutoff.
**E**: Non-zero point intensities across scans in the regions from D.
**F**: Histogram of the 99th percentile cutoffs from all of the tiled windows. Red line is the median x 1.5.
:::

::: {custom-style="MDPI_3.1_text"}
Although it appears that only a handful of potential signal regions are removed between `r figure_count$label_text("slidingwindow_count")`A and E with a cutoff of 8 non-zero points in a sliding region, the number of initial signal regions rapidly explodes as the cumulative percentile cutoff is lowered, going from thousands to tens of thousands of potential peak regions to find and fit peaks within, as shown in `r figure_count$label_text("percentile_variation")`A and B for both the amino-acid ECF and lipid samples, respectively.
:::

::: {custom-style="MDPI_5.2_figure"}

```{r percentile_variation, dn_id = figure_count, fig.width = 10, fig.height = 6}
noise_plot + plot_annotation(tag_levels = "A")
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("percentile_variation")`.**
The number of initial regions as a function of the percentile cutoff used for either the AA ECF (**A**) or lipid (**B**) samples.
:::



::: {custom-style="MDPI_2.2_heading2"}
### 2.4 Peak Characterization Using Quadratic Fit
:::

```{r increment_fit}
figure_count$increment("centroided_peaks")
```

::: {custom-style="MDPI_3.1_text"}
Although many other types of mass spectrometry data suffer from a variable and noisy baseline, the scan-level profile data from the Thermo-Fisher Fusion has a baseline of 0 due to manipulations in the Thermo-Fisher firmware, making the determination of the centroided values considerably easier. 
For each region initially created, the peaks in each scan within that region can be characterized (i.e., centroiding).
For centroiding, we use a simple weighted quadratic model of log(intensity) to m/z. 
We add a small constant to enable using the zero values, and weight the values by their ratio to the most intense value, which is normally the value closest to the center of peak, helping to ensure that the **true** centroid is determined. 
From the fitted model, we can derive the centroided center and the intensity of the peak, as shown in `r figure_count$label_text("centroided_peaks")`.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r centroided_peaks, dn_id = figure_count}
# figure showing fit of quadratic model to actual data points
tar_load(peak_fit_plot)
peak_fit_plot
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("centroided_peaks")`.**
Log-intensity (A) and Intensity (B) of points for a single peak against frequency. Black points are the original data points, and the blue point represents the calculated centroid.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.5 Breaking Up Initial Regions
:::

```{r increment_breaking_regions}
figure_count$increment("breaking_regions")
```

::: {custom-style="MDPI_3.1_text"}
With the characterized (centroided) peak data from across scans within each region, it is then important to determine if only one or multiple "peaks" are actually present in the region.
Our solution to this is to define breaks between **actual** peaks as a single frequency bin with zero characterized peaks within it.
The frequency bins are created from tiled windows that are one frequency point difference wide.
Adjacent non-zero frequency bins are merged to comprise a single peak region.
`r figure_count$label_text("breaking_regions")` shows an example where an initial region is broken up into two regions based on the characterized peak centers.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r breaking_regions, dn_id = figure_count}
# figure showing multiple "peaks" in what is initially a single region
tar_load(split_region_plot)
split_region_plot
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("breaking_regions")`.** Splitting a single region into two regions based on the peaks that are present.
**A**: The full set of raw frequency and intensity data across all scans for the region are shown.
Each horizontal trace are the point intensities in a single scan.
Clearly the region has two separate peaks within it.
**B**: The peak centroids (frequency and intensity) for each peak in black.
The tiled regions (red) are used to quantify the number of peaks.
**C**: The number of peaks within each tiled region shown as a histogram.
Each group of non-zero adjacent regions will be merged to form a new peak region.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.6 Normalization of Scans
:::

```{r increment_intensity_scan}
figure_count$increment("intensity_scan")
figure_count$increment("normalization_factors")
```

::: {custom-style="MDPI_3.1_text"}
Due to differences in how many ions are captured in the trap and the limited dynamic range of the detector, the observed peak intensities for the same analyte vary between scans (see `r figure_count$label_text("breaking_regions")`A and B for example).
Using the median peak differences between scans, it is possible to normalize the peak intensities across scans.
However, there are two issues with these peak intensities across scans: (a) some peak intensities correlate with the scan number (i.e., scan acquisition order); and (b) some peak differences between scans are correlated with intensity.
The solution to (a) is to do a two-pass normalization.
After the first pass, the peaks whose intensity is correlated with scan order are detected (absolute Pearson correlation > 0.5).
In the second pass, the correlated peaks are removed, and normalization is carried out again.
`r figure_count$label_text("intensity_scan")`A shows an example peak whose intensity across scans is correlated with scan number.
The solution to (b) (peak differences correlated with intensity) is to only use the most intense peaks, as shown in `r figure_count$label_text("intensity_scan")`B.
The highlighted peaks in `r figure_count$label_text("intensity_scan")`B are those with an intensity greater than 0.7 of the maximum intensity observed in that scan, and at least visually, their differences are **not** correlated with intensity.
If *all* peaks are used for normalization, a very different set of normalization factors will be generated than by using only the *most intense* peaks, as shown in `r figure_count$label_text("normalization_factors")`A and B.
Though the two-pass normalization (doublenorm) and single-pass normalization using the most intense peaks (singlenorm_int) generate very similar normalization factors (`r figure_count$label_text("normalization_factors")`B and C), which is expected as they both use the most intense peaks. 
But removing the scan-correlated peaks does change the majority of the normalization factors.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r intensity_scan, dn_id = figure_count}
# figure showing peak intensity correlation with m/z, intensity varying with m/z
tar_load(intensity_scan_cor_plot)
intensity_scan_cor_plot
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("intensity_scan")`.** 
**A**: An example of a peak whose height across scans is correlated with scan number.
**B**: The peak differences to the same peaks in a reference scan are plotted against peak height.
Black: Peaks with a height < 0.7 of the maximum.
Red: Peaks with a height ≥ 0.7 of the maximum.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r normalization_factors, dn_id = figure_count, fig.height = 8, fig.width = 8}
tar_load(compare_normalization)
compare_normalization[[1]]
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("normalization_factors")`.** **A**: Histogram of scan normalization factors using either a single-pass normalization using *all* peaks (singlenorm), single-pass normalization using peaks with an intensity ≥ 0.7 of the maximum intensity (singlenorm_int), or the two-pass normalization removing peaks whose height is correlated with scan and using the most intense peaks (doublenorm).
**B**: The difference of the normalization factors obtained from either doublenorm or singlenorm_int compared to singlenorm.
**C**: **B**, but with a zoomed y-axis to illustrate the differences in the normalization factors obtained with the different methods.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.7 Mitigation of High Peak Density Artifacts
:::

```{r increment_hpd}
figure_count$increment("hpd_compare_fsd")
```

::: {custom-style="MDPI_3.1_text"}
We have previously described the presence of high peak density (HPD) artifacts in FT-MS spectra [@mitchellNewMethodsIdentify2018].
Ideally, the peak characterization procedure should reduce and mitigate their presence and effect in the resultant reported peaks.
Their presence should be minimized by removing noise peaks, and removing peak regions that have multiple reported peaks from the same scan.
However, we expect they may also present as characterized peaks that have larger than expected frequency level standard deviations (FSD) when calculated across scans.
These peaks can be detected by simply examining the distribution of FSDs and marking outlier peaks.
To verify the mitigation of HPD regions, we converted centroided m/z's from Xcalibur to frequency values using the previously calculated model for that sample, and measured peak density to detect HPD regions, and compare them with the scan-centric peaks and FSD outliers.
Xcalibur peak density was measured using a sliding window ten points wide and a stride of one point.

`r figure_count$label_text("hpd_compare_fsd")` shows a single HPD site detected in the 2ecf sample, with the peaks from Xcalibur, as well as various scan-centric processing and the peaks from centroiding using MSnbase.
From this figure, we can see that the point-density-based noise filtering removes a large number of the peaks in the HPD site, while the FSD outliers removes further peaks that may be suspect.
After removing the high FSD peaks, the number of peaks left in the HPD site are the same or less than those from MSnbase, and at least in this example, look more likely to be real peaks compared to those from MSnbase.
Therefore, scan-centric characterization allows us to keep what are likely **real** peaks in HPD sites, without consideration of peak intensity, and mark peaks that may be artifactual from HPD regions.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r hpd_compare_fsd, dn_id = figure_count, fig.width = 16, fig.height = 8}
tar_load(hpd_plots_2ecf)

hpd_left_panel = wrap_plots(hpd_plots_2ecf$plots, ncol = 1)
hpd_right_panel = hpd_plots_2ecf$n %>%
  ggplot(aes(x = xcalibur,
             y = count,
             color = method)) +
  geom_point(size = 3) +
  labs(x = "Xcalibur peak count",
       y = "peak count") +
  theme(legend.position = c(0.1, 0.8))
(hpd_left_panel | hpd_right_panel) + plot_annotation(tag_levels = "A")
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("hpd_compare_fsd")`.**
Comparison of HPD and high FSD sites in the 2ecf sample.
**A** - **E**:Peak plots for various peak processing modalities in a single HPD site.
**A**: *xcalibur* peaks exported from Thermo-Fisher Xcalibur after averaging scans.
**B**: *scancentric_00*: Scan-centric peak characterization without any density-based filtering (see noperc_nonorm in Methods).
**C**: *scancentric_99*: Scan-centric peak characterization using the default point density filtering (see filtersd in Methods).
**D**: *scancentric_99_lowsd*: Same as *scancentric_99*, but removing any peaks marked as having a high frequency standard deviation.
**E**: *msnbase*: peak centroids generated from *MSnbase*.
**F**: Scatterplot of peak counts across all of the HPDs detected in the 2ecf sample against the Xcalibur peak counts.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.8 Changes in Relative Standard Deviation (RSD)
:::

```{r increment_rsd}
figure_count$increment("rsd_method")
table_count$increment("rsd_method")
```

::: {custom-style="MDPI_3.1_text"}
Each step in the peak characterization either changes the overall number of peaks coming from each scan (sliding windows and breaking initial regions) or the overall intensity of the points within a scan.
Therefore, one way to quantify any potential *improvements* in the characterized peaks is to look at the relative standard deviation (RSD) for the characterized scan level peak intensities (calculated as the standard deviation of peak heights across scans divided by the mean peak height) and compare them as each processing step is introduced.
`r figure_count$label_text("rsd_method")` illustrates the peak height RSD distributions for four different samples.
Up to two modes are reported for each distribution, where a mode location is only reported if it is ≥ 0.2X the most intense mode.
For samples 1ecf and 2ecf, there is a general shift in the RSD to the left, going from the bottom processing methods (msnbase_only) to the top processing method (filtersd), representing a visually clear improvement.
For samples 49lipid and 97lipid, the improvements are visually more subtle, having a slight shift to the left as well as a narrowing and smoothing of the RSD distribution.
Part of this subtlety is likely due to the bi-modality of these two distributions.
This is not surprising, since these two samples are non-polar extractions from tissue and are biochemically more complex.
`r table_count$label_text("rsd_method")` provides more quantitative metrics.
At two decimal places, the filtersd, doublenorm, and singlenorm processing methods give superior and nearly identical results for three of the four samples, especially in terms of mean and median RSD.
However, for sample 1ecf, the max RSD is much higher for singlenorm, highlighting its instability.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r rsd_method, dn_id = figure_count}
tar_load(rsd_plot)
wrap_plots(rsd_plot, ncol = 2)
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("rsd_method")`.**
Density plots of relative standard deviations (RSD) of peak heights across scans for each of the processing methods.
A peak had to be present in at least three scans for the RSD value to be reported.
:::

::: {custom-style="MDPI_4.1_table_caption"}
`r table_count$label_text("rsd_method")`.
RSD means, medians, modes, and maximum observed values for each sample with different overall processing.
:::

::: {custom-style="MDPI_4.2_table_body"}
```{r rsd_table, results = 'asis'}
tar_load(rsd_best)
rsd_best %>%
  autofit()
```
:::

```{r increment_rsd_intensity}
figure_count$increment("rsd_intensity")
```


::: {custom-style="MDPI_3.1_text"}
The 97lipid filtersd RSD distribution (as well as others) is bi-modal.
`r figure_count$label_text("rsd_intensity")` plots each peaks RSD as a function of the mean intensity across scans, for every peak present in at least three scans (top), or the peaks present in at least 80% of the scans (bottom).
At least part of the bi-modality in the RSD distribution appears to be related to this dependence of RSD on intensity, as well as truncation as peaks appear in fewer scans.
This is supported by part of the distribution disappearing when we require that peaks be in at least 80% of the available scans (difference between `r figure_count$label_text("rsd_intensity")` top and bottom).

We can remove a majority of the bi-modality by only examining those peaks with a Log10(mean) intensity ≥ 5.
`r supp_figure_count$label_text("rsd_method")` and `r supp_table_count$label_text("rsd_method")` show how the RSD distributions change for each sample when only the peaks with Log10(mean) intensity ≥ 5 are used.
The distributions are all shifted to lower RSD, however, the overall trends in RSD are the same.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r rsd_intensity, dn_id = figure_count, fig.height = 9}
plot_alpha = 0.4
x_lim = c(1.8, 7.4)
y_lim = c(NA, 1)
tar_load(rsd_combine)
rsd_all = rsd_combine %>%
  dplyr::filter(sample %in% "97lipid", processed %in% "filtersd") %>%
  ggplot(aes(x = log10(mean), y = rsd)) +
  geom_point(alpha = plot_alpha) + 
  coord_cartesian(xlim = x_lim, ylim = y_lim) +
  labs(subtitle = "N-Scan \u2265 3", x = "Log10(Mean)", y = "RSD")

rsd_many = rsd_combine %>%
  dplyr::filter(sample %in% "97lipid", 
                processed %in% "filtersd",
                n_perc >= 0.8) %>%
  ggplot(aes(x = log10(mean), y = rsd)) +
  geom_point(alpha = plot_alpha) +
  coord_cartesian(xlim = x_lim, ylim = y_lim) +
  labs(x = "Log10(Mean)", y = "RSD", subtitle = "N-Scan \u2265 80%")

tar_load(corrected_rsd_combine)
rsd_corrected = corrected_rsd_combine %>%
  dplyr::filter(sample %in% "97lipid",
                processed %in% "filtersd") %>%
  ggplot(aes(x = log10(mean), y = rsd)) +
  geom_point(alpha = plot_alpha) +
  coord_cartesian(xlim = x_lim, ylim = y_lim) +
  labs(x = "Log10(Mean)", y = "RSD", subtitle = "N-Scan \u2265 3, Corrected Height")
(rsd_all / rsd_many / rsd_corrected) + plot_annotation(tag_levels = "A")
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("rsd_intensity")`.**
RSD as a function of the log-mean peak intensity for the filtersd method peaks from the 97lipid sample.
**A** shows all peaks in at least three scans using raw height; **B** shows peaks that were present in at least 80% of the scans; and **C** shows all peaks in at least three scans using the corrected height.
:::

::: {custom-style="MDPI_3.1_text"}
`r figure_count$label_text("rsd_intensity")` also provides information about the sources of variance or error in the FT-MS measurements.
These trends or RSD with intensity (and SD with intensity, see `r supp_figure_count$label_text("peak_variance")`) imply both a constant, baseline additive error component that is independent of intensity, and a proportional error component where the variance increases with intensity.
When the intensity is log-transformed, this additive component becomes a dispersive variance component.
In addition, there is an unusual boot-shaped curve at the lower log mean intensities, representing left-censorship (truncation) effects due to detection limits.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.9 Difference to Relative Natural Abundance
:::

```{r nap_intensity_increment}
figure_count$increment("nap_intensity")
```

::: {custom-style="MDPI_3.1_text"}
As an alternative to RSD, we can also compare the fit of relative intensities after assignment using SMIRFE [@mitchellSmallMoleculeIsotope2019] to the theoretical relative natural abundances (relNAP) of the assigned isotopic molecular formula's (IMFs) within the assigned elemental molecular formula's (EMFs).
Theoretically, we expect lower quality data to have both lower numbers of assignments, and for those things that are assigned, the fit between relative intensity and relNAP to be worse.
To compare relative NAP to relative abundances, we only examined the assignments from the two samples containing ECF derivatized amino-acids, as we can limit the assignments to those that match expected derivatizations of the known amino-acids (see Supplemental for the expected EMFs, and expected relative NAPs for the individual IMFs).

`r figure_count$label_text("nap_intensity")` compares the peak-peak isotopic natural abundance probability and height log-ratio differences (Equation `r equation_count$label_text("napintensity")` in Methods) generated using heights from Xcalibur and from our scan-centric peak characterization.
From this figure, it is clear that inconsistency in peak presence across scans leads to larger deviations between measured peak heights from aggregate spectra and expected relNAP.
:::


::: {custom-style="MDPI_5.2_figure"}
```{r nap_intensity, dn_id = figure_count, fig.width = 16, fig.height = 8}
nap_fontsize = 9
tar_load(aa_diffs_filtersd_1ecf)
tar_load(aa_diffs_filtersd_2ecf)

all_diffs = rbind(aa_diffs_filtersd_1ecf$all_diffs %>%
                    dplyr::mutate(sample = "1ecf"),
                  aa_diffs_filtersd_2ecf$all_diffs %>%
                    dplyr::mutate(sample = "2ecf"))

threonine_ratios = aa_diffs_filtersd_1ecf$specific_diffs$ratios %>%
  dplyr::filter(source %in% c("scan-centric", "xcalibur"))
threonine_diffs = aa_diffs_filtersd_1ecf$specific_diffs$diffs %>%
  dplyr::filter(source %in% "xcal_raw_char")

threonine_ratioplot = ggplot(threonine_ratios, aes(x = ratio, y = diff, color = source, size = n_missing)) +
    geom_point() +
    theme(legend.position = c(0.7, 0.75)) +
    labs(x = "Pairwise Comparison",
         y = "Peak-Peak NAP - Height Differences") +
  theme(axis.title.y = element_text(size = nap_fontsize))

threonine_diffplot = ggplot(threonine_diffs, aes(x = n_missing, y = diff)) +
    geom_point(size = 2) +
    labs(x = "Number of Missing Scans",
         y = "Xcalibur - Scan-Centric NAP - Height Differences")+
  theme(axis.title.y = element_text(size = nap_fontsize))

aa_diffplot = all_diffs %>%
  dplyr::filter(source %in% "xcal_raw_char") %>%
  ggplot(aes(x = n_missing, y = diff)) +
  geom_point() +
  labs(x = "Number of Missing Scans",
         y = "Xcalibur - Scan-Centric NAP - Height Differences") +
  theme(axis.title.y = element_text(size = nap_fontsize))

out_plot = (threonine_ratioplot | threonine_diffplot) / aa_diffplot + plot_annotation(tag_levels = "A")
out_plot
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("nap_intensity")`.**
**A**. The peak-peak NAP - intensity log differences from scan-centric peak heights (red) and Xcalibur peak heights (blue) from the ECF derivatized threonine amino acid assignments with Na adduct, with point size reflecting how many peaks were missing across scans.
**B**. The difference of Xcalibur to scan-centric ratios plotted directly as a function of the number of scans the peak was not found in.
**C**. The differences of Xcalibur to scan-centric ratios for all of the amino acid assignments in EMFs with more than a single peak in both ECF samples.
:::

::: {custom-style="MDPI_3.1_text"}
Although we expected that the corrected scan-centric intensities would behave similarly or better compared to the raw intensities, `r supp_figure_count$label_text("nap_intensity")` shows that while they have smaller differences than Xcalibur, there is still a trend of increasing difference with the raw scan-centric intensity - NAP ratios as the number of missing scans increases.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.10 Method Specific Peaks
:::

```{r increment_peak_comparisons}
table_count$increment("unassigned_1ecf")
table_count$increment("unassigned_97lipid")

figure_count$increment("unassigned_upset")
figure_count$increment("assigned_mz_diff")

tar_load(um_peaks_1ecf)
tar_load(um_peaks_97lipid)
tar_load(ass_peaks_1ecf)
tar_load(ass_peaks_97lipid)
```

::: {custom-style="MDPI_3.1_text"}
Each set of peaks generated may or may not be specific to the particular method used to generate centroided peak m/z and intensities.
This is true for the different scan-centric combinations, as well as the peaks from Xcalibur and MSnbase.
Here we examine the overlap of the unassigned (`r figure_count$label_text("unassigned_upset")`) and assigned peaks from the full scan-centric processing with Xcalibur and MSnbase.
These same counts are also summarized in `r table_count$label_text("unassigned_1ecf")` and `r table_count$label_text("unassigned_97lipid")`.
In these two examples, there are some striking differences.
The 1ecf sample has all of the scan-centric peaks shared with either Xcalibur or MSnbase peaks, whereas the 97lipid sample has 2/3 of the peaks specific to scan-centric characterization and not matched to either of the other methods.
Notably, for both samples, the scan-centric characterization produces similar numbers of peaks, even though the upper mass limit in 1ecf is 1000 m/z compared to 1600 m/z for the 97lipid sample.
Whereas the number of peaks from MSnbase and Xcalibur are three-fold and 40-fold higher in the 1ecf sample compared to the 97lipid sample.

`r figure_count$label_text("assigned_mz_diff")` shows the distribution of differences between the observed and expected m/z of assigned peaks in the 1ecf and 97lipid spectra.
For the 1ecf-specific histograms, it is clear that these differences have a narrower unimodal distribution from the scan-centric peak characterization, especially in comparison to MSnbase.
Also, the MSnbase distribution has far fewer peaks that match a scan-level assigned peak.
Given the large number of MSnbase-characterized peaks present in the spectrum, many peaks may be outside the matching tolerance of 2ppm. 
This strongly implies that the peak center error is far higher in the MSnbase-characterized peaks than what the histogram directly shows.
For the 97lipid-specific histograms, again the difference distribution for the scan-centric peak characterization is narrower, but the improvement is not as pronounced, likely due to the distribution being bi-modal.
Also, far fewer Xcalibur and MSnbase characterized peaks matched assigned scan-centric peaks.
Again, this strongly implies that their peak centers have far higher error.
:::

```{r unassigned_upset, dn_id = figure_count, fig.width = 16, fig.height = 8}
set_order = c("scancentric", "msnbase", "xcalibur")
u1 = grid::grid.grabExpr(draw(UpSet(um_peaks_1ecf$comb_matrix, 
                           set_order = set_order)))
u2 = grid::grid.grabExpr(draw(UpSet(um_peaks_97lipid$comb_matrix, 
                           set_order = set_order)))

up_plot = wrap_elements(u1, clip = FALSE) + wrap_elements(u2, clip = FALSE)
up_plot + plot_annotation(tag_levels = "A")
```

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("unassigned_upset")`.**
UpSet plot with the counts of common and specific peaks without consideration of assignments for each of scancentric, MSnbase and Xcalibur generated peaks for the 1ecf (**A**) and 97lipid (**B**) samples.
The black points with connected vertical lines identify which set intersections are represented in the bar at the top.
A single black point identifies what was specific to the set and not in any other sets.
:::

::: {custom-style="MDPI_4.1_table_caption"}
`r table_count$label_text("unassigned_1ecf")`.
Number of matched peaks between peak processing methods for 1ecf.
There are no overlapping peaks only between scancentric and msnbase, as well as no peaks found only by the scancentric method.
:::
::: {custom-style="MDPI_4.2_table_body"}
```{r unassigned_1ecf}
um_peaks_1ecf$ft_table %>%
  autofit()
```
:::

::: {custom-style="MDPI_4.1_table_caption"}
`r table_count$label_text("unassigned_97lipid")`.
Number of matched peaks between peak processing methods for 97lipid.
:::

::: {custom-style="MDPI_4.2_table_body"}
```{r unassigned_97lipid}
um_peaks_97lipid$ft_table %>%
  autofit()
```
:::

::: {custom-style="MDPI_2.2_heading2"}
###
:::

::: {custom-style="MDPI_5.2_figure"}
```{r assigned_mz_diff, dn_id = figure_count}
get_base_limits = function(in_peaks, bins = 30){
  in_base = in_peaks %>%
  dplyr::filter(source2 %in% "MSnbase") %>%
  ggplot(aes(x = ppm_diff)) + 
  geom_histogram(bins = bins) 
  in_limit = ggplot_build(in_base)$data[[1]]
  in_limit
}

plot_mz_diffs = function(in_peaks, limits, ylimit = NULL, inset = FALSE){
  purrr::map(c("Scan-Centric", "Xcalibur", "MSnbase"), function(in_method){
    tmp_peaks = in_peaks %>%
      dplyr::filter(source2 %in% in_method)
    peak_count = purrr::map_dfr(seq(1, nrow(limits)), function(in_row){
      data.frame(x = limits[in_row, "x"],
                 y = sum(between(tmp_peaks$ppm_diff, limits[in_row, "xmin"], limits[in_row, "xmax"])))
    })
    base_plot = peak_count %>%
      ggplot(aes(x = x, y = y)) +
      geom_col() +
      labs(x = "", y = "count", subtitle = in_method)
    
    if (in_method %in% "MSnbase") {
      base_plot = base_plot +
        labs(x = "abs(ppm) Difference")
    }
    
    if (!is.null(ylimit)) {
      base_plot = base_plot +
        coord_cartesian(ylim = c(NA, ylimit))
    }
    if (inset && (in_method %in% c("Xcalibur", "MSnbase"))) {
      inset_plot = peak_count %>%
        ggplot(aes(x = x, y = y)) +
        geom_col() +
        labs(x = "", y = "") +
        theme(axis.text.x = element_blank(),
              axis.text.y = element_text(size = 6))
      out_plot = base_plot + inset_element(inset_plot, 0.2, 0.1, 1, 1)
    } else {
      out_plot = base_plot
    }
    out_plot
  })
}


diffs_1ecf = ass_peaks_1ecf$peaks %>%
  dplyr::mutate(source2 = dplyr::case_when(
    source %in% "scanlevel" ~ "Scan-Centric",
    source %in% "xcalibur" ~ "Xcalibur",
    source %in% "msnbase" ~ "MSnbase"
  ),
    ppm_diff = abs(mz_diff / mz) * 1e6) 

ecf_limits = get_base_limits(diffs_1ecf)

ecf_plots = plot_mz_diffs(diffs_1ecf, ecf_limits, ylimit = 40)

diffs_97lipid = ass_peaks_97lipid$peaks %>%
  dplyr::mutate(source2 = dplyr::case_when(
    source %in% "scanlevel" ~ "Scan-Centric",
    source %in% "xcalibur" ~ "Xcalibur",
    source %in% "msnbase" ~ "MSnbase"
  ),
    ppm_diff = abs(mz_diff / mz) * 1e6)


lipid_limits = get_base_limits(diffs_97lipid)

lipid_plots = plot_mz_diffs(diffs_97lipid, lipid_limits, ylimit = 800, inset = TRUE)

wrap_plots(ecf_plots, ncol = 1) | wrap_plots(lipid_plots, ncol = 1) 
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("assigned_mz_diff")`.**
Histograms of the differences between observed and expected m/z values for assigned peaks in the 1ecf (**left**) and 97lipid (**right**) spectra, measured in parts-per-million (ppm) respectively.
Inset plots are scaled to the maximum counts observed for the particular method.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.11 Changes in P-Values On a Large Dataset
:::

```{r increment_p_value}
tar_load(lung_compare)
lung_compare = lung_compare %>%
  dplyr::mutate(compare_id = dplyr::case_when(
    id.test %in% "corrected" ~ "Corrected",
    id.test %in% "xcalibur" ~ "Xcalibur",
    id.test %in% "msnbase" ~ "MSnbase"
  ))

compare_split = split(lung_compare, lung_compare$compare_id)
figure_count$increment("p_value_comparison")
```

::: {custom-style="MDPI_3.1_text"}
For large datasets, we expect that more correct peak intensities will result in better agreement between sample normalized peak intensities within a sample class.
One way to test this is to compare p-values generated from the different intensities.
`r figure_count$label_text("p_value_comparison")` compares the -1 * Log10(p-values) from `r nrow(compare_split$Corrected)` (corrected and Xcalibur) or `r nrow(compare_split$MSnbase)` (MSnbase) isotope resolved molecular formulas (IMFs) assigned by SMIRFE for the scan-centric peaks and then peaks matched and intensities extracted from the other methods.
Although all of the p-vaues are somewhat (and statistically) different from those reported by the raw intensities, there are some interesting patterns of differences.
MSnbase generated p-values show the widest distribution of differences, as well as the smallest number of peaks that are present in 50% of both the cancer and non-cancer samples.
This echoes the patterns of low overlapping assigned peaks observed in both ECF samples, where many of the scan-centric amino-acid peaks only found one match from the MSnbase peaks.
Surprisingly, the truncated log-normal distribution corrected intensities generated very different p-values compared to the raw intensities, and Xcalibur showed the most agreement with the raw p-values.
We tested the statistical significance of these differences using a t-test of the actual difference in log-p-values (shown in `r figure_count$label_text("p_value_comparison")`D).
It is clear that the raw scan-centric intensities are superior.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r p_value_comparison, dn_id = figure_count, fig.width = 8, fig.height = 8}
tar_load(lung_compare_ttest)

compare_plots = purrr::imap(compare_split, function(in_compare, id){
  out_plot = in_compare %>%
    ggplot(aes(x = log_p.ref, y = log_p.test)) +
    geom_abline(slope = 1, color = "red") +
    geom_point(alpha = 0.5) +
    coord_equal() +
    labs(x = "Log-P-Value Raw",
         y = paste0("Log-P-Value ", id))
  out_plot
})

long_ttest = lung_compare_ttest %>%
  dplyr::select(p.adjust, comparison, estimate, conf.low, conf.high) %>%
  tidyr::pivot_longer(cols = !comparison, names_to = "measure", values_to = "value") %>%
  dplyr::mutate(compare_id = dplyr::case_when(
    comparison %in% "corrected" ~ "Corrected",
    comparison %in% "xcalibur" ~ "Xcalibur",
    comparison %in% "msnbase" ~ "MSnbase"
  ))

long_pvalue = long_ttest %>%
  dplyr::filter(measure %in% "p.adjust")

long_measure = long_ttest %>%
  dplyr::filter(!(measure %in% "p.adjust"))

compare_sina = lung_compare %>%
  ggplot(aes(x = compare_id, y = p_diff)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_sina(alpha = 0.5) +
  geom_point(data = long_measure, aes(x = compare_id, y = value), color = "green") +
  geom_text(data = long_pvalue, aes(x = compare_id, y = -5, label = format(value, digits = 2))) +
  labs(x = "", y = "Log-P-Value Difference")

lung_plot = (compare_plots$Corrected | compare_plots$MSnbase) / (compare_plots$Xcalibur | compare_sina) +
  plot_annotation(tag_levels = "A")
  

lung_plot
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("p_value_comparison")`.**
**A - C**: Log-p-values generated by comparing non-cancer and cancer sample IMFs using peak intensities from different methods.
Red line denotes perfect agreement.
**D**: Sina plot of differences in the log-p-values generated by different methods compared to the raw scan-centric log-p-values.
Also shown are the Bonferroni adjusted p-values from a t-test of the log-p-value differences for each method.
Green points denote the high, mean, and low-confidence limits reported from the t-test.
:::

::: {custom-style="MDPI_3.1_text"}
It is vitally important however, to normalize the intensities correctly.
`r supp_figure_count$label_text("p_value")` of the Supplemental Materials shows that with the incorrect normalization, the corrected and raw p-values become much closer to each other.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 2.12 Quality Control and Quality Analysis
:::

```{r load_increment_qcqa}
figure_count$increment("coefficients_qcqa")
figure_count$increment("resolution_qcqa")
tar_load(coefficients_qcqa)
```

::: {custom-style="MDPI_3.1_text"}
Having a scan-centric workflow for generating the peak centroids means that we have opportunities to evaluate the scans as a whole, as well as the peaks across scans.
For example, we can mark peaks with unusually high frequency standard deviations (FSD) and mitigate the presence of high-peak-density artifacts (see **Mitigation of High Peak Density Artifacts**).
We also sometimes find that from initial peak region that has been marked as a single region, still results in two peaks being characterized in a single scan.
This results in that peak being removed from that scan entirely.

The conversion of m/z to frequency also provides opportunities to evaluate each scan and whether it should be kept for further processing.
Checks that have helped us in the development of the scan-centric peak characterization have included: (i) verifying that the ordering of data points remains identical in m/z and frequency space after conversion to frequency; and (ii) examining the R^2^ fit of the predicted frequency points to the original frequency points across scans for outliers.
A third quality control step is to examine the coefficients of the square-root term for each scan (see term **y** in Equation `r equation_count$label_text("mzfrequency")`) and look for any outliers, and remove them before continuing the sample processing.
Across the `r length(coefficients_qcqa$n_coef_out)` NSCLC raw files that completed scan-centric processing, `r sum(coefficients_qcqa$n_coef_out > 0)` had at least one scan removed based on the square-root coefficient.
`r figure_count$label_text("coefficients_qcqa")`A shows a histogram of the number of scans removed based on being outliers of the overall distribution.
`r figure_count$label_text("coefficients_qcqa")`B shows what outlier scan coefficients look like in a single sample.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r coefficients_qcqa, dn_id = figure_count}
coef_df1 = data.frame(N_out = coefficients_qcqa$n_coef_out)
coef_g1 = coef_df1 %>%
  ggplot(aes(x = N_out)) + 
  geom_histogram() +
  labs(x = "# of Scan Outliers", y = "# of Samples")

coef_g2 = coefficients_qcqa$example %>%
  ggplot(aes(x = sample, y = coefficient, color = outlier, group = sample)) +
  geom_sina(size = 2) +
  labs(x = "", y = "Square-Root Term") +
  theme(legend.position = c(0.1, 0.8))

(coef_g1 | coef_g2) + plot_annotation(tag_levels = "A")
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("coefficients_qcqa")`.**
**A**: Number of scan outliers for each sample in the NSCLC dataset.
**B**: Single example for sample 199Cpos of the scan square-root terms, with outliers marked and removed from further consideration.
:::

::: {custom-style="MDPI_3.1_text"}
A final check we implemented in the conversion to frequency was verifying that the range of frequency point-point differences allowed for creating the m/z to frequency model are the same across scans.
The initial set of scans we started with included **all** of the MS1 scans, including the precursor scans for the MS2 scans. 
However, the samples were acquired as a mix of MS1 only scans for the first 7.5 minutes, and then a mix of MS1 precursor scans followed by MS2 scans for the second 7.5 minutes.
In 20 samples, the MS1 precursor scans have a different resolution than the MS1 main scans, as shown in `r figure_count$label_text("resolution_qcqa")`.
This is easy to detect by differences in the square-root coefficients, but due to using a single frequency model for converting all scans actually **manifested** as different modes in the point-point frequency differences.
Oddly enough, the check for outlier scans discussed previously, does not flag any of the scans as outliers in this case.
Ultimately, we were able to resolve this anomaly by only using those scans with an injection time before 7.5 minutes.
In the future, the package will be updated to check that the resolution is the same across the scans, and produce an informative error for the end user before quitting.
:::

::: {custom-style="MDPI_5.2_figure"}
```{r resolution_qcqa, dn_id = figure_count}
tar_load(resolution_qcqa)

resolution_qcqa %>%
  ggplot(aes(x = rtime, xend = rtime, y = 0, yend = tic, color = sqrt)) +
  geom_segment() +
  theme(legend.position = c(0.8, 0.8)) +
  labs(x = "Injection Time (s)", y = "TIC", color = "Coefficient") +
  coord_cartesian(ylim = c(NA, 2e7)) +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  scale_x_continuous(expand = expansion(mult = c(0, .1)))
```
:::

::: {custom-style="MDPI_5.1_figure_caption"}
**`r figure_count$label_text("resolution_qcqa")`.**
Scan-level total ion chromatogram (TIC) plot noting the square-root coefficient for each scan, where the coefficient is reflective of the resolution used for each scan.
The y-axis is cropped to 2x10^7^ so that the MS1 precursor scans are visible, as their TIC's are much smaller than the others.
:::

::: {custom-style="MDPI_3.1_text"}
Finally, in the scan-scan normalization step, we require that there are at least 25 peaks in each of the scans that can be used to calculate normalization factors between the scans and the reference scan.
If there are no scans with at least 25 peaks, then the processing of that sample will error and stop.
:::

::: {custom-style="MDPI_2.1_heading1"}
## 3. Discussion
:::

::: {custom-style="MDPI_3.1_text"}
FT-MS direct-injection data provides spectral scans; however, unlike nuclear magnetic resonance, these spectral scans are not identical, due to several instrumentation issues.
Therefore, simple scan summation or averaging to an aggregate spectrum followed by peak characterization does not provide optimal data.
Also, this approach prevents the calculation of useful peak-specific statistics, especially variances, both in m/z and intensity.
In the results presented, we demonstrate superior performance by scan-centric peak characterization in terms of: (a) improved QC/QA that removes low quality scans; (b) intensity independent noise reduction that pragmatically eliminates HPD sites; (c) improved peak height relative standard deviations; (d) improved peak intensity ratios that better match natural abundance probabilities; and (e) better separation between biological groups.
These improvements are necessary for downstream derivation of molecular formula by SMIRFE using spectrum-derived tolerances, an efficient m/z search of a large isotope-resolved cache, and filtering by peak ratio matching to NAP.
However, scan-centric peak characterization requires a sophisticated pipeline of QC/QA and processing steps to derive a superior characterization with informative statistics and QC/QA metrics.
Years of methods development, testing, and optimization have gone into the methods presented here.
But once implemented, large datasets can be processed in a straight-forward manner that supports full computational reproducibility.
We also kept all steps that provided a demonstrable improvement, no matter how small that improvement was, but the following steps provided the most improvement: (a) noise removal by non-zero point density, (b) scan normalization using median peak intensity differences, and (c) removal of outlier scans. 
However, both steps a and c require the m/z to frequency regression model. 
In the end, it is the combination of steps that synergistically provide the presented superior peak characterization results. 
We note that the non-zero point density based noise removal is particularly useful, as the peak intensities from scan to scan are not identical, which would possibly hamper any kind of intensity based noise removal.

Not all of the methods presented here provided an improvement.
We included our negative results with correcting mean and standard deviations for the intensity of peaks not detected in all scans, so that others do not waste effort pursuing this.
We initially expected the data to follow a truncated log-normal distribution, since `r figure_count$label_text("rsd_intensity")` clearly demonstrates truncation effects; however, upon further contemplation of the results presented here, we believe that the differences between scans still present after normalization imparts a dispersive variance component.
Moreover, `r figure_count$label_text("rsd_intensity")` (and `r supp_figure_count$label_text("peak_variance")`) demonstrates the presence of an additive error component that will become dispersive after log-transformation.
Thus, we hypothesize that a truncated negative binomial distribution may better represent the intensity of peaks not detected across all scans.
Fortunately, this distribution has been previously studied [@sampfordTruncatedNegativeBinomial1955a] and we plan to explore this possibility for a future improvement to our methods.
However, correction may not be straight-forward and it is unclear if it is better to apply the correction to the raw or log-transformed peak height data.
Either way, a dispersive variance component is present and must be accounted for.
As illustrated in `r figure_count$label_text("rsd_intensity")`, there are low intensity peaks that are observed across the majority of the scans.
This likely indicates that the loss of peak detection involves other factors that are increased at low intensity.
We theorize that any factor that increases signal decoherence like ion-cloud repulsion would increase the peak flooring performed by the instrument.
Therefore, access to the scan level peak intensity information as provided by the methods presented here facilitates the inference of sources and types of error present in the measurements, which we believe have been previously under-described and is required for future data processing improvements.
:::

::: {custom-style="MDPI_2.1_heading1"}
## 4. Materials and Methods
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.1 Samples and Overall Processing
:::

::: {custom-style="MDPI_3.1_text"}
Two different sets of samples were used to evaluate the various methods, ethylchloroformate (ECF) derived amino acid samples described in [@mitchellSmallMoleculeIsotope2019] and non-small-cell-lung-carcinoma (NSCLC) lipid-extracted tissue samples described in [@mitchellUntargetedLipidomicsNonSmall2021].

The method for generating the amino-acid samples was adapted from a previously published method for performing ECF amino acid derivatization [@yangChloroformateDerivatizationTracing2017]. 
Two replicate samples were prepared and spectra were obtained for both samples using a Tribrid Fusion Orbitrap at 500k resolution and a mass range of 150 to 1000m/z.

The collection, preparation, and mass spectrometry analysis of the paired cancer and non-cancer samples has been previously described [@sellersPyruvateCarboxylaseCritical2015]. 
In summary, cancer and nearby non-cancer tissue samples were acquired from eight-six non-diabetic patients with suspected resectable stage I or IIA non-small cell lung cancer. 
Written informed consent was collected from all subjects prior to inclusion and all samples were collected under a University of Louisville or University of Kentucky IRB protocol. 
Lipid extracts were prepared using a modified Folch extraction and reconstituted for direct infusion ultra-high resolution mass spectrometry on a pair of Thermo-Fisher Tribrid Fusion Orbitrap instruments coupled to an Advion nanoelectrospray system. 
Two of the cancer lipid samples (49Cpos and 97Cpos) were used for the majority of examples in this manuscript.
The rest were included for the examination of changes in differential analysis p-values using different peak source intensities (see **Differential Analysis of Large Dataset**).
:::

::: {custom-style="MDPI_3.5_text_before_list"}
For each of the two ECF and two lipid samples, the raw data file was converted to profile mzML format.
Only the MS1 scans were used, and the scan-scan time difference had to be ≥ 4 seconds, and for the lipid samples only scans acquired before 450 seconds (7.5 minutes) were kept.
The scan-centric data was then processed in the following eight ways:
:::

::: {custom-style="MDPI_3.8_bullet"}
* No noise removal, no normalization (noperc_nonorm)
:::
::: {custom-style="MDPI_3.8_bullet"}
* Noise removal, no normalization (perc99_nonorm)
:::
::: {custom-style="MDPI_3.8_bullet"}
* Noise removal, single-pass normalization with all peaks (singlenorm)
:::
::: {custom-style="MDPI_3.8_bullet"}
* Noise removal, single-pass normalization with high ratio peaks (singlenorm_int)
:::
::: {custom-style="MDPI_3.8_bullet"}
* Noise removal, two-pass normalization (doublenorm)
:::
::: {custom-style="MDPI_3.8_bullet"}
* Noise removal, two-pass normalization (filtersd)
:::

::: {custom-style="MDPI_3.8_bullet"}
* Scans merged and then centroids generated by MSnbase (using `combineSpectra` and `pickPeaks`)
:::

::: {custom-style="MDPI_3.8_bullet"}
* Scans merged and peak-list exported by Xcalibur
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.2 Matching Peaks
:::

::: {custom-style="MDPI_3.1_text"}
To associate the Xcalibur and MSnbase peaks with the scan-centric peaks, a 4 ppm (2ppm low and high) window is calculated for the scan-centric centroid, and if any peaks are found within the window, the one with the smallest m/z difference is kept as the matching peak to the scan-centric one under consideration.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.3 Conversion of m/z to Frequency
:::


::: {custom-style="MDPI_3.1_text"}
The input data consists of profile mode m/z spectra from multiple scans encoded as m/z and intensity values for each scan.
No information about the original observed frequency values is available in either the `raw` files or the `mzML` files.
However, proxy frequency values can be generated by averaging the m/z of adjacent points and dividing them by the m/z difference.
Ideally, the difference between subsequent points in this proxy frequency space is constant, in practice there is a range of differences in frequency space.
The *actual, constant* difference can be obtained by examining the median of the calculated frequency differences, and then constraining *useful* points (those that can be used for generating a model of frequency to m/z) to be within 2% of the mode value.
These *useful* points can be used to construct a linear model relating m/z to frequency for individual scans based on the formula:
:::

::: {custom-style="MDPI_3.9_equation"}
`r format_equation('frequency = a + \\frac{x}{mz} + \\frac{y}{\\sqrt{mz}} + \\frac{z}{\\sqrt[3]{mz}}', 'mzfrequency')`
:::

::: {custom-style="MDPI_3.1_text"}
From the known physical properties of the Orbitrap, only the square root term should be necessary [@ledfordSpaceChargeEffects1984].
Practically, we have found the combination of no root, square and cube-roots to provide a better fit when processing data from the Thermo-Fisher Fusion instrument, likely due to issues with slight imperfections in the orbitrap geometry, contributions from space charge effects and magnetronic motion, control of the magnetic fields, and the Fourier-like transform conversion used by the spectrometer.
We do note that when working with Bruker SolariX ICR data, the equation is slightly different, and does not require the cubic square root term (unpublished results, see Supplemental Materials).
A frequency model is generated for each scan, and then a single model using the scan with the square-root term closest to the median of the square-root terms from all scans.
We observed that this single model better preserved the relative ordering of the peaks in both m/z and frequency-space compared to the scan specific models (see Results).

To convert m/z back into frequency, we can use a similar model without the roots, as well as an extra simple linear term that doesn't have an equivalent in the above frequency model.
:::

::: {custom-style="MDPI_3.9_equation"}
`r format_equation('mz = a + x \\times \\frac{1}{frequency} + y \\times \\frac{1}{frequency^2} + z \\times \\frac{1}{frequency^3}', 'frequencymz')`
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.4 Frequency Intervals
:::

::: {custom-style="MDPI_3.1_text"}
Two types of frequency intervals are used, sliding and tiled windows.
In this work, the sliding windows are the equivalent of 10 frequency points wide with a stride of one point.
The tiled windows are one point wide with a stride of one point.
Each **point** above is the equivalent of the difference between data points in frequency space, which in these samples have a spacing of 0.5.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.5 Interval Range Based Data
:::

::: {custom-style="MDPI_3.1_text"}
To enable interval algebra, the frequency points are converted to single width intervals by multiplying by a constant factor to maintain the differences in individual points (a multiplier of 400 in this work), rounding to the nearest integer, and storing them as IRanges objects from the IRanges Bioconductor package [@lawrenceSoftwareComputingAnnotating2013a].
The sliding and tiled windows are also converted to IRanges objects using this process.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.6 Peak Containing Intervals
:::

::: {custom-style="MDPI_3.1_text"}
To find intervals that contain points that represent actual signal and not just random noise, the number of non-zero intensity points in each sliding window are counted.
Subsequently, we break these counts into fixed width tiles (default width of 1000 in frequency space) and calculate the 99th percentile of non-zero points for each tile.
The rounded up median value x 1.5 of these 99th percentile values from the fixed width tiles is used as the cutoff value to determine which of the initial sliding regions should be kept as regions containing potential signal.
Any sliding window with a non-zero count less than or equal to the cutoff value is removed, and the remaining sliding windows are kept and overlapping sliding windows are merged to create the initial peak regions.
The presence of zero intensity points in these Thermo-Fisher Orbitrap spectra are primarily due to flooring implemented by the spectrometer when local spectral quality falls below a certain threshold.
When this flooring is unstable and incomplete, a partial ringing phenomenon is observed [@mitchellNewMethodsIdentify2018].

Within each initial interval region, peaks in each scan are detected (see **Peak Detection and Centroided Values**), and their centers are binned by the tiled windows.
Adjacent tiled windows with non-zero peak counts are merged together, and any zero peak count tiled windows split the initial region into multiple peak interval regions.
These interval regions should contain a single **real** peak that was detected in one or more scans.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.7 Peak Detection and Centroided Values
:::

::: {custom-style="MDPI_3.1_text"}
On a single scan level, possible peaks are detected by simple bump-hunting for two increasing points followed by two decreasing points using the `find_peaks` function in the pracma package [@borchersPracmaPracticalNumerical2021].
These possible peaks are then characterized using a weighted parabolic fit of log-intensity to position (where position is either m/z or frequency), and the weights for each point are the relative log-intensity compared to the maximum log-intensity for the peak.
:::

::: {custom-style="MDPI_3.9_equation"}
`r format_equation('\\ln(intensity) = a + x \\times position + y \\times position^2', 'modelintensity')`
:::

::: {custom-style="MDPI_3.1_text"}
From this weighted parabolic fit, the center, intensity, integrated area and sum-of-square residuals can be extracted for the peak.
The center and intensity from this model are equivalent to the centroided peak center and intensity.

Before further processing, each region is verified to have only one peak from each scan.
If a scan has two or more peaks in a region, then the scan level data in that region is discarded.
Any regions that subsequently contain zero peaks are removed.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.8 Scan to Scan Normalization
:::

::: {custom-style="MDPI_3.1_text"}
Scans are normalized to a single *reference* scan based on the log-intensity differences of a subset of peaks present in at least the same number of scans as the 95th percentile of scan counts for the peaks.
In addition, only those peaks with an intensity greater than 0.7 times the highest intensity peak in the scan are used.
Pairwise scan-to-scan distances are calculated by taking the cartesian distances between log peak intensities present in both scans, and then the cartesian distance is summed across the scan-to-scan distance to provide an overall difference of each scan to all other scans.
The scan with the lowest summed overall distance is chosen as the *reference* scan ($scan_{ref}$), and normalization factors for each scan are calculated as the median log peak intensity differences in $scan_i$ compared to the $scan_{ref}$.
This normalization is done twice, once using all possible peaks, after which the correlation of peak intensity with scan order is checked, and those peaks with correlation of greater than 0.5 with scan order are removed, and the normalization factors are calculated again, and then applied to both the centroided peak height and the raw point intensities.
Peaks correlated to scan order represent an artifact that we speculate results from a gradient in the sample well and are marked in the final output.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.9 Full Scan-Centric Characterization
:::

::: {custom-style="MDPI_3.1_text"}
The full set of raw data points for each peak in each scan within a region is known based on the previously detected peaks.
Therefore, the non-zero intensity, normalized raw data points across scans can be combined, and then characterized again using the weighted parabolic fit method previously described.
In addition to the data from the full set of raw points, the means and the standard deviations of the peak height and location can be derived from the scan-level peak characteristics previously calculated.

In addition to these values, the frequency point-to-point median difference is calculated across all of the raw data points for those points that could be used for modeling frequency to m/z, and this difference of a single point from the peak center is calculated in frequency space, and converted to m/z space to provide an "offset" value that is potentially useful to define the search space around the peak for any assignment algorithm.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.10 Correction of Height and Standard Deviation
:::

::: {custom-style="MDPI_3.1_text"}
Ideally, each peak would be observed in every scan.
However, some peaks are not observed in some scans due to the number of ions falling below the detection threshold, or being excluded after filling the trap.
This should result in a left-censored log-normal distribution of peak intensities across equivalent scans, which is expected for analytical measurements with detection limits [@flightInformationContentInformedKendalltauCorrelation2022].
To correct these, either a correction based on a model of the truncated normal distribution can be used on log-transformed data, or the differences can be simulated by sampling from data that is present in most of the scans.
To simulate the effect of peaks missing from some scans on the standard deviations, the peaks present in all scans are used.
For each peak, a sample of the heights across scans are taken (ranging from 5% to 95% of scans), and a new standard deviation calculated for that fraction, and a ratio of the fractional standard deviation to the "true" standard deviation calculated.
The ratio standard deviation across peaks can then be fitted to a cubic model of the fraction used, and a correction factor predicted for those peaks that are present in fewer scans.
Our correction uses log-transformed peak heights, and differences instead of raw heights and ratios directly to make some of the calculations easier.
The corrected standard deviations can then be used to correct the mean height assuming that it is the result of a left-censored normal distribution [@TruncatedNormalDistribution2022; @burkardtTruncatedNormalDistribution].
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.11 Marking High Frequency Standard Deviation Peaks
:::

::: {custom-style="MDPI_3.1_text"}
High-peak-density (HPD) artifacts [@mitchellNewMethodsIdentify2018] present as groups of singular peaks with higher than expected frequency standard deviations (FSDs) calculated from the scan-to-scan frequency peak locations.
Outliers are detected by calculating the interquartile range (IQR) of the distribution of FSDs across the entire spectrum, and peaks with FSDs greater than the median plus 1.5 times the IQR (as implemented in boxplot.stats) are marked.
The HPD detection algorithm from Mitchell et al. was re-implemented in R for this work to allow comparisons between it and the use of the FSD.
For HPD detection, the peaks in excel output from Xcalibur were used after converting the m/z peak centers into frequency space.
Sliding windows that are 1000 frequency points wide with a stride of 100 points were used for the density calculations.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.12 Calculation of Relative Standard Deviation
:::

::: {custom-style="MDPI_3.1_text"}
For consistency across both the various scan-centric centroiding and MSnbase, the scan level Log10 heights were converted to raw heights, and then averages and standard deviations calculated across scans, removing missing values.
Relative standard deviation (RSD) was calculated as standard deviation divided by the mean for each peak.
The number of scans a peak was present in was also noted, as well as the percentage of total scans.
Only peaks present in at least three scans were kept for analysis of the RSD.

Modes of the RSD are calculated starting from a density approximation of the distribution using default settings in the density function of the R stats package.
Peaks from the density approximation are determined with the findpeaks function in the pracma package.
Up to two modes are reported from low to high RSD along the distribution: i) the most intense peak; ii) the next most intense peak if it is ≥ 0.2X the most intense peak.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.13 Scan-Centric Peak Assignment
:::

::: {custom-style="MDPI_3.1_text"}
Our previously described SMIRFE algorithm [@mitchellSmallMoleculeIsotope2019] was used to assign molecular formulas to scan-centric characterized peaks in an untargeted manner. 
For the lipid samples, an initial EMF database was generated using an m/z limit of 1605 m/z, and maximum numbers for each element were set to C: 130, N: 7, O: 28, P: 3, H: 230. 
Assigned formulas were allowed to have K^+^, Na^+^, H^+^, and NH4^+^ adducts (only positive mode samples were assigned). 
Assigned molecular formulas were then classified into one or more lipid categories using our lipid classifier tool [@mitchellDerivingLipidClassification2020].
For the ECF derivatized amino-acid samples, the EMF database was generated using an m/z limit of 1005 m/z, and maximum numbers for each element were set to C: 100, N: 7, O: 40, H: 230, P: 3, S: 3.
^15^N labeling was included in the database generation.
Assigned formulas were allowed to have H^+^ and Na^+^ adducts.

We attempted to create peaks that could be assigned by SMIRFE from the MSnbase and Xcalibur peak lists, but SMIRFE would not assign them given its requirements for scan-centric peak characterization data that includes variance.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.14 Consistently Assigned Lipid Spectral Feature (Corresponded Peak) Generation and Peak Intensity Normalization
:::

::: {custom-style="MDPI_3.1_text"}
Our SMIRFE assignment method assigns isotope-resolved molecular formulas (IMFs) to characterized peaks in each spectrum. 
Each IMF represents an isotopologue of a given elemental molecular formula (EMF) (e.g., 13C112C51H1216O6 is an IMF representing the m+13C1 isotopologue of EMF C6H12O6). Consistently assigned (i.e., corresponded peaks) are identified using an in-house method we have named EMF voting.

Elemental molecular formula (EMF) voting was used to match peaks across samples and determine the most likely assignments from SMIRFE. 
First, for each sample, the assignments are extracted, filtered, and scored. Any assignments that contain only peaks that were marked as being questionable (high FSD or correlated with scan number) removed. 
Scores are calculated as 1 – E-value, and for the lipids, EMFs that were classified as lipids had their score multiplied by 2.

For each sample, peaks were grouped to a sample specific EMF by determining the list of shared EMFs across a group of peaks (grouped_EMF). 
Scores for each formula in the grouped_EMF in the sample were taken as the best score for that formula from available scores in the group. 
After all sample grouped_EMFs are generated, additional scores for a formula are considered in actual voting by looking for the same unadducted base EMF with different adducts and adding these scores into the final total score. 

The pseudo_EMFs are collections of grouped_EMFs across samples. 
They are generated across samples by iteratively merging grouped_EMFs with shared formulas, creating a new list of formulas in an EMF, and merging any pseudo_EMFs that have shared formulas again.

For each pseudo_EMFs, the most likely formulas are determined by voting. 
Voting uses the sum of EMF scores across samples, including those from the same formula with a different adduct. 
Those formulas with a total score in the top 90% of all total scores were considered “winning” formulas and kept as the "voted formula" set. 
Any peaks that did not originally have a "voted formula" were then checked to see if the peak location was within previously defined tolerance, and if the ordered peak intensities for the set of peaks from a sample are in the same order as the natural abundance probabilities of IMFs for the voted EMF. 
If so, then the peaks are kept as having the "voted formula" set.

After voting, all of the peaks are checked to make sure that the peak locations are within previously defined m/z specific cutoffs. 
Any peak outside of its specific cutoff is removed.

Finally, those pseudo_EMFs that share greater than 50% of their peaks are merged together, and voting on the EMFs is performed again.

Peak locations from our custom data processing pipeline are reported both in m/z and frequency, which are derived from the m/z values. 
The frequency values are more reliable (i.e., more consistent with less variance), but differ between instruments. 
Therefore, for each set of samples from a particular instrument, we use high confidence assignments (e-value <= 0.1, m/z <= 600) to derive a frequency cutoff using the mode of the distribution of frequency standard deviations across both groups of samples. 
This frequency cutoff is used to do EMF voting within an instrument. 
The m/z standard deviations of the voted peaks are then fit to m/z using a generalized additive model, and the standard deviation of the predicted m/z values are multiplied by 2 to derive an m/z cutoff so that voting can be performed across the instruments.

```{r load_lipid_full_data}
tar_load(scancentric_imfs_raw)
```

EMF voting identified `r nrow(scancentric_imfs_raw$intensity)` total corresponded peaks across all `r ncol(scancentric_imfs_raw$intensity)` spectra.
All lipid isotopologue intensities were normalized by dividing the isotopologue intensity by the median intensity of all the peaks in the sample. 
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.15 Peak - Peak NAP Height Ratios
:::

::: {custom-style="MDPI_3.1_text"}
Each pair of peaks in a specifically labeled and adducted elemental molecular formula are related by their natural abundance probability (NAP).
Theoretically, the log-ratios of two peaks NAPs are approximately equal to the log-ratios of two peaks intensities.
:::

::: {custom-style="MDPI_3.9_equation"}
`r format_equation('\\ln(NAP_{P1} / NAP_{P2}) - \\ln(Int_{P1} / Int_{P2}) \\approx 0', 'napintensity')`
:::

::: {custom-style="MDPI_3.1_text"}
SMIRFE assignments include the NAP for each of the isotopologue molecular formulas (IMFs) in the particular labelled and adducted EMF.
For each peak pair in the peak group for a particular EMF, we calculate the log-ratio for the NAPs and the log-ratio for the intensities, and their absolute differences.
This calculation is done for the final characterized intensity, as well as the intensities at the scan level, and for both the *raw* intensity and *corrected* intensity, and for matched Xcalibur peak intensities, and matched MSnbase peak intensities if there were two or more matching peaks in the labeled, adducted EMF.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.16 Differential Analysis of Large Dataset
:::

```{r load_qcqa}
tar_load(qcqa)
n_out = qcqa$outlier_data %>%
  dplyr::group_by(sample_class) %>%
  dplyr::summarise(n_out = sum(outlier))
n_out_vector = n_out$n_out
names(n_out_vector) = n_out$sample_class
```

::: {custom-style="MDPI_3.1_text"}
To compare p-value changes in a large multi-class sample dataset, we used the full set of NSCLC lipid samples described earlier.
We started with the 181 matched non-cancer and cancer samples previously used for HPD detection and lipidomics of non-small-cell-lung-cancer (NSCLC) [@mitchellNewMethodsIdentify2018; @mitchellUntargetedLipidomicsNonSmall2021].
All samples were characterized using the full scan-centric workflow, assigned using SMIRFE (see **Scan-Centric Peak Assignments**), and then peaks matched by shared EMFs across samples (see **Consistently Assigned Lipid Spectral Feature (Corresponded Peak) Generation and Peak Intensity Normalization**).
After extraction of the scan-centric IMF peak locations across all samples, Xcalibur and MSnbase peaks were matched within each sample, and locations and intensities extracted.

Of the starting 181 samples, five did not finish during scan-centric characterization due to not having any scans left during normalization.
In addition, some of the samples were acquired multiple times, creating duplicate samples.
Not knowing which sample run was most appropriate to use, we removed all of the duplicated samples.
Using information-content-informed Kendall-tau correlation (ICI-Kt) [@flightInformationContentInformedKendalltauCorrelation2022], we compared the median correlations of each sample to all others in the same disease class for outliers, and removed `r n_out_vector["cancer"]` cancer and `r n_out_vector["non-cancer"]` samples.
The median ICI-Kt correlations are shown in `r supp_figure_count$label_text("icikt_outlier")`.

Each samples intensities were normalized by dividing by the median intensities from that sample and intensity method.
Only those peaks present in 50% of both the non-cancer and cancer samples were kept for differential analysis.
This resulted in `r nrow(compare_split$Corrected)` IMF peaks for differential analysis.
Differential analysis used the logged intensity values, with p-values calculated using `rowttests` function from the `genefilter` Bioconductor package (v1.76.0) [@gentlemanGenefilterMethodsFiltering2021], removing any missing values before calculation.
P-values were adjusted using the Benjamini-Hochberg method in the p.adjust function from the base R stats package (v4.1.0) [@rcoreteamLanguageEnvironmentStatistical2021a].

For comparisons across peak sources, we converted both the raw p-values to log-p-values by calculating -1 * Log10(p-value).
The reference peak p-value is the raw scan-centric p-values.
:::

::: {custom-style="MDPI_2.2_heading2"}
### 4.17 Software Used
:::

::: {custom-style="MDPI_3.1_text"}
Thermo-Fisher Xcalibur was used to export peak lists from all samples used.
SMIRFE v 1.0 [@mitchellSmallMoleculeIsotope2019] running under Python 3.8 [@vanrossumPython3] was used for assignments.
Lipid classifications were generated by LipidClassifier v 1.0 [@mitchellDerivingLipidClassification2020].
All other calculations were performed in R v 4.1.0 [@rcoreteam_rlanguage_2020].
The targets package v 0.10.0 was used to control processing and aggregation of results [@landauTargetsPackageDynamic2021], and renv v 0.15.3 [@usheyRenvProjectEnvironments2022] to create a reproducible R package environment.
Plots were generated using ggplot2 v 3.3.5 [@wickhamGgplot2ElegantGraphics2016], patchwork v 1.1.1 [@pedersenPatchworkComposerPlots2020], ComplexHeatmap v 2.10.0 [@guComplexHeatmapsReveal2016a], ggridges v 0.5.3 [@wilkeGgridgesRidgelinePlots2021], and ggforce v 0.3.3 [@pedersenGgforceAcceleratingGgplot22021].
MSnbase v 2.20.4 [@gattoMSnbaseEfficientElegant2020; @gattoMSnbaseBioconductorPackage2012] provided facilities for reading in scan-level data, merging scans and calculating centroided peaks.
ICI-Kt correlation values among lipid samples were calculated using ICIKendallTau v 0.1.16 [@flightInformationContentInformedKendalltauCorrelation2022].
Outlier lipid samples were determined using visualizationQualityControl v 0.4.7 [@flightVisualizationQualityControlDevelopmentVisualization2021].
Specific data manipulation facilities were provided by dplyr v 1.0.8 [@wickhamDplyrGrammarData2022], tidyr v 1.2.0 [@wickhamTidyrTidyMessy2022], furrr v 0.2.3 [@vaughanFurrrApplyMapping2021a].
This manuscript was generated from rmarkdown v 2.11 [@allaireRmarkdownDynamicDocuments2021; @xieMarkdownDefinitiveGuide2018; @xieMarkdownCookbook2020].
:::

::: {custom-style="MDPI_2.2_heading2"}
###
:::

::: {custom-style="MDPI_6.2_BackMatter"}
**Author Contributions**: All authors have read and agreed to the published version of the manuscript. 
Conceptualization, R.M.F, and H.N.B.M; Methodology, R.M.F and H.N.B.M.; Software, R.M.F.; Validation, R.M.F, J.M.M. and H.N.B.M.; Formal Analysis: R.M.F. and H.N.B.M.; Investigation: J.M.M., R.M.F, and H.N.B.M; Resources, H.N.B.M.; Data Curation, R.M.F; Writing – Original Draft Preparation, R.M.F, J.M.M. and H.N.B.M; Writing – Review & Editing, R.M.F, J.M.M. and H.N.B.M; Visualization, R.M.F. and H.N.B.M.; Supervision, H.N.B.M; Project Administration, H.N.B.M.; Funding Acquisition, H.N.B.M.
 
**Funding**: The work was supported in part by grants NSF 1419282 (PI Moseley), NSF 2020026 (PI Moseley), NIH 1P01CA163223-01A1 (PD Lane), 1U24DK097215-01A1 (PD Higashi), and P30 CA177558 (B.M. Evers, PI) via the Markey Cancer Center Biostatistics and Bioinformatics Shared Resource Facility (MCC BB-SRF).

**Data Availability Statement**: The code used in the reporting of results is available on GitHub at https://github.com/MoseleyBioinformaticsLab/manuscript.peakCharacterization, and archived on Zenodo [@flightMoseleyBioinformaticsLabManuscriptPeakCharacterization2022].
The scan-centric peak-characterization is available as an R package at https://github.com/MoseleyBioinformaticsLab/FTMS.peakCharacterization, and the specific version used in this work is archived on Zenodo [@flightMoseleyBioinformaticsLabFTMSPeakCharacterization2022].

**Conflicts of Interest**: The authors declare no conflict of interest. 
The funders had no role in the design of the study; in the collection, analyses, or interpretation of data; in the writing of the manuscript, or in the decision to publish the results.
:::

::: {custom-style="MDPI_2.1_heading1"}
## References
:::


